<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Import & Belian - Muiz Banner Empire</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- FontAwesome untuk Ikon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel untuk memproses JSX dalam browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
  <div id="root"></div>

  <!-- Sambungan Firebase Cloud (Waktu Nyata) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBpIAU2H1E_RD-Kw6nNVjLKz4C88WVW074",
      authDomain: "rekod-pembelian.firebaseapp.com",
      projectId: "rekod-pembelian",
      storageBucket: "rekod-pembelian.firebasestorage.app",
      messagingSenderId: "686407023060",
      appId: "1:686407023060:web:8f89674a4f4b86af0ffe41"
    };

    window.firebaseApp = initializeApp(firebaseConfig);
    window.firebaseAuth = getAuth(window.firebaseApp);
    window.firebaseDb = getFirestore(window.firebaseApp);
    window.firebaseFns = { signInAnonymously, onAuthStateChanged, collection, doc, setDoc, deleteDoc, onSnapshot };
    
    window.dispatchEvent(new Event('firebase-ready'));
  </script>

  <!-- Kod Aplikasi Utama React -->
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const APP_ID = 'muiz-banner-empire';

    function App() {
      const [user, setUser] = useState(null);
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [loginData, setLoginData] = useState({ username: '', password: '' });
      const [loginError, setLoginError] = useState('');
      const [records, setRecords] = useState([]);
      const [formData, setFormData] = useState({
        dateTime: '', itemName: '', quantity: '', itemCost: '', shippingCost: '', roiPercentage: '300'
      });

      // Tetapkan Auth Firebase
      useEffect(() => {
        let unsubscribe = null;
        const setupAuth = async () => {
          try {
            await window.firebaseFns.signInAnonymously(window.firebaseAuth);
          } catch (error) {
            console.error("Ralat pengesahan Firebase:", error);
          }
          unsubscribe = window.firebaseFns.onAuthStateChanged(window.firebaseAuth, setUser);
        };

        if (window.firebaseAuth) {
          setupAuth();
        } else {
          window.addEventListener('firebase-ready', setupAuth);
        }

        return () => {
          if (unsubscribe) unsubscribe();
          window.removeEventListener('firebase-ready', setupAuth);
        };
      }, []);

      // Ambil data dari Firebase
      useEffect(() => {
        if (!user || !window.firebaseFns) return;
        
        const recordsRef = window.firebaseFns.collection(window.firebaseDb, 'artifacts', APP_ID, 'users', user.uid, 'purchases');
        const unsubscribe = window.firebaseFns.onSnapshot(recordsRef, (snapshot) => {
          const data = [];
          snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
          data.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
          setRecords(data);
        }, (error) => {
          console.error("Ralat mengambil data dari awan:", error);
        });

        return () => unsubscribe();
      }, [user]);

      // Tetapan masa lalai
      useEffect(() => {
        const now = new Date();
        const formattedDateTime = now.toISOString().slice(0, 16);
        setFormData(prev => ({ ...prev, dateTime: formattedDateTime }));
      }, []);

      // Fungsi Log Masuk
      const handleLogin = (e) => {
        e.preventDefault();
        if (loginData.username === 'admin' && loginData.password === 'muiz123') {
          setIsAuthenticated(true);
          setLoginError('');
        } else {
          setLoginError('Username atau password salah!');
        }
      };

      const handleLoginChange = (e) => {
        setLoginData({ ...loginData, [e.target.name]: e.target.value });
      };

      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
      };

      // Pengiraan Automatik
      const calculatedUnitCost = useMemo(() => {
        const qty = parseFloat(formData.quantity);
        const cost = parseFloat(formData.itemCost) || 0;
        const shipping = parseFloat(formData.shippingCost) || 0;
        if (qty > 0) return ((cost + shipping) / qty).toFixed(2);
        return '0.00';
      }, [formData.quantity, formData.itemCost, formData.shippingCost]);

      const calculatedSellingPrice = useMemo(() => {
        const unit = parseFloat(calculatedUnitCost) || 0;
        const roi = parseFloat(formData.roiPercentage) || 0;
        if (unit > 0) return (unit + (unit * (roi / 100))).toFixed(2);
        return '0.00';
      }, [calculatedUnitCost, formData.roiPercentage]);

      const stats = useMemo(() => {
        const totalSpent = records.reduce((sum, record) => sum + record.itemCost + record.shippingCost, 0);
        const totalItems = records.reduce((sum, record) => sum + record.quantity, 0);
        const totalShipping = records.reduce((sum, record) => sum + record.shippingCost, 0);
        return { totalSpent: totalSpent.toFixed(2), totalItems, totalShipping: totalShipping.toFixed(2) };
      }, [records]);

      // Simpan dan Padam Data
      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.itemName || !formData.quantity || !formData.itemCost || !user || !window.firebaseFns) return;

        const newRecordId = Date.now().toString();
        const newRecord = {
          dateTime: formData.dateTime,
          itemName: formData.itemName,
          quantity: parseFloat(formData.quantity),
          itemCost: parseFloat(formData.itemCost) || 0,
          shippingCost: parseFloat(formData.shippingCost) || 0,
          unitCost: parseFloat(calculatedUnitCost),
          roiPercentage: parseFloat(formData.roiPercentage) || 0,
          suggestedPrice: parseFloat(calculatedSellingPrice),
          createdAt: new Date().toISOString()
        };

        try {
          const docRef = window.firebaseFns.doc(window.firebaseDb, 'artifacts', APP_ID, 'users', user.uid, 'purchases', newRecordId);
          await window.firebaseFns.setDoc(docRef, newRecord);
          setFormData(prev => ({ ...prev, itemName: '', quantity: '', itemCost: '', shippingCost: '' }));
        } catch (error) {
          console.error("Ralat menyimpan rekod:", error);
        }
      };

      const deleteRecord = async (id) => {
        if (!user || !window.firebaseFns) return;
        try {
          const docRef = window.firebaseFns.doc(window.firebaseDb, 'artifacts', APP_ID, 'users', user.uid, 'purchases', id);
          await window.firebaseFns.deleteDoc(docRef);
        } catch (error) {
          console.error("Ralat memadam rekod:", error);
        }
      };

      const formatDate = (dateString) => {
        const date = new Date(dateString);
        return new Intl.DateTimeFormat('ms-MY', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }).format(date);
      };

      // --- PAPARAN LOG MASUK ---
      if (!isAuthenticated) {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-white p-8 rounded-2xl shadow-xl border border-slate-100 w-full max-w-md">
              <div className="flex justify-center mb-6">
                <div className="bg-blue-600 w-16 h-16 flex items-center justify-center rounded-2xl text-white shadow-lg shadow-blue-200">
                  <i className="fa-solid fa-lock text-3xl"></i>
                </div>
              </div>
              <h1 className="text-2xl font-bold text-center text-slate-900 mb-2">Log Masuk Sistem</h1>
              <p className="text-center text-slate-500 mb-8">Muiz Banner Empire</p>

              {loginError && (
                <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm font-semibold mb-6 text-center border border-red-100">
                  {loginError}
                </div>
              )}

              <form onSubmit={handleLogin} className="space-y-5">
                <div>
                  <label className="block text-sm font-semibold text-slate-600 mb-1">Username</label>
                  <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                      <i className="fa-solid fa-user"></i>
                    </div>
                    <input type="text" name="username" value={loginData.username} onChange={handleLoginChange} className="w-full pl-10 pr-3 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Masukkan username" required />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-slate-600 mb-1">Password</label>
                  <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                      <i className="fa-solid fa-lock"></i>
                    </div>
                    <input type="password" name="password" value={loginData.password} onChange={handleLoginChange} className="w-full pl-10 pr-3 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Masukkan password" required />
                  </div>
                </div>
                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-blue-200 transition-all">
                  Log Masuk
                </button>
              </form>
            </div>
          </div>
        );
      }

      // --- PAPARAN SISTEM UTAMA ---
      return (
        <div className="min-h-screen p-4 md:p-8">
          <div className="max-w-6xl mx-auto space-y-6">
            
            {/* Header */}
            <header className="flex items-center justify-between mb-8">
              <div className="flex items-center space-x-3">
                <div className="bg-blue-600 w-14 h-14 flex items-center justify-center rounded-xl text-white shadow-lg shadow-blue-200">
                  <i className="fa-solid fa-box-open text-2xl"></i>
                </div>
                <div>
                  <h1 className="text-2xl md:text-3xl font-bold text-slate-900">Sistem Import & Belian</h1>
                  <p className="text-slate-500 font-medium">Muiz Banner Empire</p>
                </div>
              </div>
              <button onClick={() => setIsAuthenticated(false)} className="flex items-center space-x-2 bg-white border border-slate-200 hover:bg-red-50 hover:text-red-600 text-slate-600 px-4 py-2 rounded-lg transition-colors font-semibold shadow-sm">
                <i className="fa-solid fa-right-from-bracket"></i>
                <span className="hidden sm:inline">Log Keluar</span>
              </button>
            </header>

            {/* Statistik */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4">
                <div className="bg-emerald-100 w-12 h-12 flex items-center justify-center rounded-full text-emerald-600">
                  <i className="fa-solid fa-arrow-trend-up text-xl"></i>
                </div>
                <div>
                  <p className="text-sm text-slate-500 font-semibold">Jumlah Pelaburan (RM)</p>
                  <p className="text-2xl font-bold text-slate-800">{stats.totalSpent}</p>
                </div>
              </div>
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4">
                <div className="bg-blue-100 w-12 h-12 flex items-center justify-center rounded-full text-blue-600">
                  <i className="fa-solid fa-boxes-stacked text-xl"></i>
                </div>
                <div>
                  <p className="text-sm text-slate-500 font-semibold">Jumlah Kuantiti Barang</p>
                  <p className="text-2xl font-bold text-slate-800">{stats.totalItems}</p>
                </div>
              </div>
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4">
                <div className="bg-orange-100 w-12 h-12 flex items-center justify-center rounded-full text-orange-600">
                  <i className="fa-solid fa-truck text-xl"></i>
                </div>
                <div>
                  <p className="text-sm text-slate-500 font-semibold">Total Kos Pos/Kargo (RM)</p>
                  <p className="text-2xl font-bold text-slate-800">{stats.totalShipping}</p>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              
              {/* Kolum Kiri: Borang */}
              <div className="lg:col-span-1">
                <div className="bg-white p-6 rounded-2xl shadow-md border border-slate-100 sticky top-8">
                  <h2 className="text-lg font-bold flex items-center mb-6 text-slate-800">
                    <i className="fa-solid fa-plus text-blue-600 mr-2"></i> Rekod Belian Baru
                  </h2>
                  
                  <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                      <label className="block text-sm font-semibold text-slate-600 mb-1">Tarikh & Masa</label>
                      <div className="relative">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                          <i className="fa-solid fa-calendar-days"></i>
                        </div>
                        <input type="datetime-local" name="dateTime" value={formData.dateTime} onChange={handleChange} className="w-full pl-10 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-slate-600 mb-1">Nama Barang</label>
                      <input type="text" name="itemName" value={formData.itemName} onChange={handleChange} placeholder="Contoh: Banner Material 380gsm" className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required />
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-slate-600 mb-1">Kuantiti (Pukal)</label>
                      <input type="number" name="quantity" min="1" step="0.01" value={formData.quantity} onChange={handleChange} placeholder="0" className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-semibold text-slate-600 mb-1">Kos Barang (RM)</label>
                        <input type="number" name="itemCost" min="0" step="0.01" value={formData.itemCost} onChange={handleChange} placeholder="0.00" className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-slate-600 mb-1">Kos Pos/Cukai (RM)</label>
                        <input type="number" name="shippingCost" min="0" step="0.01" value={formData.shippingCost} onChange={handleChange} placeholder="0.00" className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-slate-600 mb-1">Sasaran Keuntungan / ROI (%)</label>
                      <div className="relative">
                        <input type="number" name="roiPercentage" min="0" step="0.1" value={formData.roiPercentage} onChange={handleChange} className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" />
                        <div className="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-slate-400 font-bold">%</div>
                      </div>
                    </div>

                    <div className="mt-6 p-4 bg-slate-50 border border-slate-200 rounded-xl space-y-4 shadow-inner">
                      <div>
                        <div className="flex justify-between items-center mb-1">
                          <span className="text-sm font-semibold text-slate-600 flex items-center">
                            <i className="fa-solid fa-calculator mr-2"></i> Harga Modal Sebiji
                          </span>
                        </div>
                        <div className="text-2xl font-bold text-slate-800 flex items-center">
                          <span className="text-base mr-1 text-slate-500">RM</span> {calculatedUnitCost}
                        </div>
                      </div>
                      
                      <div className="border-t border-slate-200"></div>

                      <div>
                        <div className="flex justify-between items-center mb-1">
                          <span className="text-sm font-semibold text-emerald-700 flex items-center">
                            <i className="fa-solid fa-arrow-trend-up mr-2"></i> Cadangan Harga Jualan
                          </span>
                          <span className="text-xs font-bold text-emerald-600 bg-emerald-100 px-2 py-0.5 rounded-full">
                            ROI {formData.roiPercentage || 0}%
                          </span>
                        </div>
                        <div className="text-3xl font-black text-emerald-600 flex items-center">
                          <span className="text-lg mr-1 text-emerald-500">RM</span> {calculatedSellingPrice}
                        </div>
                        <p className="text-xs text-emerald-600 mt-1 font-medium">
                          Untung Kasar: RM {((parseFloat(calculatedSellingPrice) || 0) - (parseFloat(calculatedUnitCost) || 0)).toFixed(2)} / item
                        </p>
                      </div>
                    </div>

                    <button type="submit" className="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-blue-200 transition-all flex justify-center items-center">
                      <i className="fa-solid fa-plus mr-2"></i> Simpan Rekod Belian
                    </button>
                  </form>
                </div>
              </div>

              {/* Kolum Kanan: Senarai */}
              <div className="lg:col-span-2">
                <div className="bg-white rounded-2xl shadow-md border border-slate-100 overflow-hidden">
                  <div className="p-6 border-b border-slate-100 bg-white">
                    <h2 className="text-lg font-bold flex items-center text-slate-800">
                      <i className="fa-solid fa-clock-rotate-left text-blue-600 mr-2 text-xl"></i> Sejarah Belian
                    </h2>
                  </div>
                  
                  <div className="overflow-x-auto">
                    {records.length === 0 ? (
                      <div className="p-12 text-center text-slate-400 flex flex-col items-center">
                        <i className="fa-solid fa-box-open text-6xl mb-4 text-slate-300"></i>
                        <p>Tiada rekod belian buat masa ini.</p>
                        <p className="text-sm mt-1">Sila tambah rekod di ruangan sebelah.</p>
                      </div>
                    ) : (
                      <table className="w-full text-left border-collapse">
                        <thead>
                          <tr className="bg-slate-50 text-slate-500 text-sm">
                            <th className="p-4 font-semibold whitespace-nowrap">Tarikh/Masa</th>
                            <th className="p-4 font-semibold">Barang</th>
                            <th className="p-4 font-semibold text-right">Modal Sebiji</th>
                            <th className="p-4 font-semibold text-right">Cadangan Jualan</th>
                            <th className="p-4 font-semibold text-right">Kos Keseluruhan</th>
                            <th className="p-4 font-semibold text-center">Tindakan</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                          {records.map((record) => (
                            <tr key={record.id} className="hover:bg-slate-50 transition-colors">
                              <td className="p-4 text-sm whitespace-nowrap">{formatDate(record.dateTime)}</td>
                              <td className="p-4">
                                <div className="font-bold text-slate-800">{record.itemName}</div>
                                <div className="text-xs text-slate-500 mt-1">Kuantiti: {record.quantity}</div>
                              </td>
                              <td className="p-4 text-right">
                                <span className="inline-block px-3 py-1 bg-slate-100 text-slate-700 font-bold rounded-lg text-sm">
                                  RM {record.unitCost.toFixed(2)}
                                </span>
                              </td>
                              <td className="p-4 text-right">
                                <span className="inline-block px-3 py-1 bg-emerald-100 text-emerald-800 font-bold rounded-lg text-sm">
                                  RM {record.suggestedPrice.toFixed(2)}
                                </span>
                                <div className="text-xs text-emerald-600 mt-1 font-semibold whitespace-nowrap">
                                  Untung: RM {(record.suggestedPrice - record.unitCost).toFixed(2)} ({record.roiPercentage}%)
                                </div>
                              </td>
                              <td className="p-4 text-right text-sm">
                                <div>RM {(record.itemCost + record.shippingCost).toFixed(2)}</div>
                                <div className="text-xs text-slate-400 mt-1 whitespace-nowrap">
                                  (Kos: {record.itemCost.toFixed(2)} + Pos: {record.shippingCost.toFixed(2)})
                                </div>
                              </td>
                              <td className="p-4 text-center">
                                <button onClick={() => deleteRecord(record.id)} className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition">
                                  <i className="fa-solid fa-trash-can"></i>
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    )}
                  </div>
                </div>
              </div>
              
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
